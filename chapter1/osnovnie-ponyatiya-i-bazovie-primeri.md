# Основные понятия, установка, настройка, примеры работы.

---

## Введение

При построении сервис-ориентированной архитектуры встает вопрос обмена данными между компонентами системы. Это легко внедрением системы обмена сообщениями. Хорошим примером такой системы является [RabbitMQ](https://www.rabbitmq.com/).

RabbitMQ - это брокер сообщений, который управляет передачей сообщений в очереди.

## Основные понятия

RabbitMQ это сервер реализующий очереди сообщений по протоколу AMQP. Как и большинство серверов поддерживает механизмы авторизации и управление уровнем доступа.

---

### Основные термины AMQP

**Exchange** - точка обмена сообщениями. Exchange играет ключевую роль в распределении сообщений, т.к. все сообщения которые не попали в какую либо очередь будут удалены. Маршрутеризация сообщений зависит от точки обмена.

**Queue** - очередь сообщений. Место куда подключается Consumer и получает сообщения. Если получателей нет - сообщения сохраняются в очереди.

**Message** - сообщение. Пакет бинарных данных с различными заготовками. У сообщения в очереди есть два состояния: Ready \(готово к доствке\) и Unacked \(в обработке/не подтвержено получение\). Сообщения в стейте Ready будут переданы следующему свободному получателю, Unacked - остается висеть в очереди, его дальнейшая передача другиму получателю блокируется, получение других сообщений получившему данное сообщение так же блокируется.

**Binding** - связь. Связь определяется двумя точками и ключом маршрутеризации.

---

#### Exchange

Конфигурация точки обмена решает дальнейшую судьбу сообщений. Конфигурация точки обмена состоит из типа и аттрибутов.

##### Типы точек обмена

**Fanout **-  сообщение будет передано во все привязанные очереди, при этом ключ  маршрута будет игнорироваться. Обычно применяется для уведомлений всех. Пример реальной жизни - чат. Отправитель \(producer\) написал в чат \(exchange\) сообщение и его получили по сети \(queues\) все полдписчики \(consumers\). Так же, в таком режиме работы игнорируется маршрут \(routing key\) сообщения.

**Direct** - позволяет нам рулить получением. К точке подключаются очереди с указанием маршрута и все переданные сообщения, имеющие такой же маршрут, будут переданы во все эти очереди.

**Topic** - подписка по шаблону. Гибкая система передачи сообщений с указанием шаблона маршрута. Шаблон представляет собой строку с разделителями и знаками **\*** или **\#.**

```
. - разделитель
* - одно слово
# - любое количество слов

site.api.v2.orders.create
site.api.v2.*.delete
site.api.v3.#

127.0.0.*
89.108.#

/** ну мы же крутые парни */
* - одно слово, например ловить все сообщения от сайта ( api || front || mp || pizza )
# - god mode, око саурона, Ванга. Читать все сообщения.
    В этом режиме с данным типом точки обмена время жизни сервера RabbitMQ и получателей
    будет зависеть от параметров точки, параметров очередей, параметров сообщений,
    количества RAM, io и свободного места. Размер сообщениий так же будет влиять на сеть между mq
    и получателями. 
    Если вы сильны духом - экспериментируйте с количетсвом локальных слушателей, которые
    пишут в разные физические (hdd, remote) места.
```

**Headers** - роутинг по заголовкам. Когда ключ передаеся в заголовке сообщения. Дарксайд, производительность не изучена, произовдитель рекомендует \(пока\) не пользоваться этим типом в больших потоках. Экспериментальные бенчмарки показывают бОльшую скорость работы очередей при таком типе.

```
/** джедай роутинга */

Отличие от примера выше - одно сообщений с массивом заголовков
[
    'X-VENDOR-COMPONENT' : 'WAREHOUSE'
    'X-VENDOR-SERVICE' : 'ORDER'
    'X-VENDOR-STATE' : 'NEW'
    'X-VENDOR-SOURCE' : 'SITE'
    'X-VENDOR-STEP' : '0'
    'X-VENDOR-STATUS' : 'N'    
    'REMOTE_IP' : '8.8.8.8'
    'HOST' : 'HOSTNAME.RU'
] [ message body ]

Теперь подключаем очереди с параметрами:
[
    'HEADER' : 'VALUE',
    .
    .
    .
    'HEADER' : 'VALUE',
    'X-MATCH' : 'ANY | ALL'
]

ANY - совпадение любых
ALL - совпадение всех
```

---

#### Queue

Очередь привязывается к точке обмена с указанием ключа. Так же, можно привязывать и обратно - точка обмена к очереди. Такой вариант работает, если очереди постоянны.

В зависимости от параметров очереди она может быть постоянной или удаляться если у нее нет больше получателей. **AutoDelete** - удаление очередей если нет слушателей. Внимание! При autoDelete = true у очереди есть риск потери сообщений.

**Durable** - очередь будет создана при перезапуске сервера.

**Exclusive** - очередь может быть использована только одним получателем.

Одна очередь может иметь несколько подписчиков. В этом случае передача сообщений от точки до получателя происходит по принципу round robin \(каждому по очереди\).

**Arguments** - служебные данные. Обычно используется различными плагинами для передачи таких вещей как TTL.

---

#### Сообщение

Сообщение состоит из тела, заголовков, аттрибутова и ключа маршрута.

Тело сообщения - бинарные данные. Сюда можно положить все что угодно, но при проектировании стоит учитывать размер передаваемых сообщений, т.к. он прямым образом влияет на производительность сервера очередей.

Заголовки - **headers**. Нестандартные заголовки следует указывать с префиксом 'X-SomeHeader'.

Ключ и аттрибуты указывают как сервер должен обрабатывать сообщение.

**Delivery mode** - persistent / not persistent. Сообщения, так же как и очереди, могут быть персистентными - сохранятся в очередях после перезапуска сервера.

**Content-type** и **content-encoding** - тип и кодировка контента сообщения.

---

## Установка, настройка.

RabbitMQ довольно гибкий сервер. Основные фичи это кластеризация, виртуальные хосты, пользователи и разрешения.

Разрешения регулируют возможности управления, чтения и записи сообщений в сервер и виртуальный хост.

В больших системах, с большим количеством получателей - поддержка зоопарка точек и очередей довольно нетривиальная задача. В продакшн средах стоит использовать опции персистентности на всю катушку и убрать права управления \(создание/удаление/биндигг точки/очереди\).

Кластер позволяет иметь одну точку входа, а виртуальный хост позволит, например, разделить дев и продакшн среды.



